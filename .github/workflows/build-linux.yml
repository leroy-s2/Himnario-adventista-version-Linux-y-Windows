name: Build Linux AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libmpv-dev mpv
        sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev gstreamer1.0-plugins-good gstreamer1.0-plugins-bad
        sudo apt-get install -y fuse libfuse2

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Build Linux Release
      run: flutter build linux --release

    - name: Install appimagetool
      run: |
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool
        sudo mv appimagetool /usr/local/bin/

    - name: Create AppImage structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy Flutter build
        cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/usr/share/applications/himnario-adventista.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Himnario Adventista
        Comment=Himnario de la Iglesia Adventista
        Exec=himnario_adventista
        Icon=himnario-adventista
        Categories=Audio;Music;
        Terminal=false
        EOF
        
        # Copy desktop file to root (required for AppImage)
        cp AppDir/usr/share/applications/himnario-adventista.desktop AppDir/
        
        # Create icon (using a placeholder - replace with actual icon)
        if [ -f "assets/images/icon.png" ]; then
          cp assets/images/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/himnario-adventista.png
          cp assets/images/icon.png AppDir/himnario-adventista.png
        else
          # Generate a simple placeholder icon
          convert -size 256x256 xc:brown -fill white -gravity center -pointsize 48 -annotate 0 "HA" AppDir/himnario-adventista.png || echo "Icon not generated"
        fi
        
        # Create AppRun script
        cat > AppDir/AppRun << 'APPRUN'
        #!/bin/bash
        APPDIR="$(dirname "$(readlink -f "$0")")"
        export LD_LIBRARY_PATH="$APPDIR/usr/bin/lib:$LD_LIBRARY_PATH"
        exec "$APPDIR/usr/bin/himnario_adventista" "$@"
        APPRUN
        chmod +x AppDir/AppRun

    - name: Build AppImage
      run: |
        ARCH=x86_64 appimagetool AppDir HimnarioAdventista-x86_64.AppImage

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: HimnarioAdventista-Linux-AppImage
        path: HimnarioAdventista-x86_64.AppImage
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: HimnarioAdventista-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
