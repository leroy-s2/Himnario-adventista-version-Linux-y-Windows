name: Build Linux AppImage

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Linux build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y ninja-build libgtk-3-dev libmpv-dev mpv

    - name: Get Flutter packages
      run: flutter pub get

    - name: Build Linux app
      run: flutter build linux --release

    - name: Create distribution package
      run: |
        # Create distribution folder
        mkdir -p dist/HimnarioAdventista
        
        # Copy the built app
        cp -r build/linux/x64/release/bundle/* dist/HimnarioAdventista/
        
        # Create empty audio directories for users to fill
        mkdir -p dist/HimnarioAdventista/data/flutter_assets/assets/audio/cantado
        mkdir -p dist/HimnarioAdventista/data/flutter_assets/assets/audio/instrumental
        echo "Coloca aquí los archivos MP3 de himnos cantados (1.mp3 - 614.mp3)" > dist/HimnarioAdventista/data/flutter_assets/assets/audio/cantado/LEEME.txt
        echo "Coloca aquí los archivos MP3 instrumentales (1.mp3 - 614.mp3)" > dist/HimnarioAdventista/data/flutter_assets/assets/audio/instrumental/LEEME.txt
        
        # Copy icon
        if [ -f "assets/images/icon.png" ]; then
          cp assets/images/icon.png dist/HimnarioAdventista/himnario-adventista.png
        fi
        
        # Create launcher script
        cat > dist/HimnarioAdventista/himnario-adventista.sh << 'LAUNCHER'
        #!/bin/bash
        cd "$(dirname "$0")"
        ./himnario_adventista
        LAUNCHER
        chmod +x dist/HimnarioAdventista/himnario-adventista.sh
        
        # Create install script
        cat > dist/HimnarioAdventista/INSTALAR.sh << 'INSTALL'
        #!/bin/bash
        echo "=== Instalador Himnario Adventista ==="
        
        INSTALL_DIR="$HOME/.local/share/HimnarioAdventista"
        DESKTOP_FILE="$HOME/.local/share/applications/himnario-adventista.desktop"
        
        # Create install directory
        mkdir -p "$INSTALL_DIR"
        
        # Copy files
        echo "Copiando archivos..."
        cp -r ./* "$INSTALL_DIR/"
        chmod +x "$INSTALL_DIR/himnario_adventista"
        chmod +x "$INSTALL_DIR/himnario-adventista.sh"
        
        # Create desktop entry
        echo "Creando acceso directo..."
        mkdir -p "$HOME/.local/share/applications"
        cat > "$DESKTOP_FILE" << EOF
        [Desktop Entry]
        Type=Application
        Name=Himnario Adventista
        Comment=Himnario de la Iglesia Adventista del Séptimo Día
        Exec=$INSTALL_DIR/himnario-adventista.sh
        Icon=$INSTALL_DIR/himnario-adventista.png
        Categories=Audio;Music;Education;
        Terminal=false
        EOF
        
        echo ""
        echo "=== Instalación completada ==="
        echo "Ahora copia los archivos MP3 a:"
        echo "  $INSTALL_DIR/data/flutter_assets/assets/audio/cantado/"
        echo "  $INSTALL_DIR/data/flutter_assets/assets/audio/instrumental/"
        echo ""
        echo "La aplicación aparecerá en el menú de aplicaciones."
        INSTALL
        chmod +x dist/HimnarioAdventista/INSTALAR.sh
        
        # Create README
        cat > dist/HimnarioAdventista/LEEME.txt << 'README'
        =======================================
        HIMNARIO ADVENTISTA - Instalación Linux
        =======================================
        
        INSTALACIÓN RÁPIDA:
        1. Abre una terminal en esta carpeta
        2. Ejecuta: ./INSTALAR.sh
        3. Copia tus archivos MP3 a las carpetas indicadas
        4. Busca "Himnario Adventista" en el menú de aplicaciones
        
        EJECUCIÓN SIN INSTALAR:
        1. Copia los MP3 a data/flutter_assets/assets/audio/cantado/ e instrumental/
        2. Ejecuta: ./himnario-adventista.sh
        
        ARCHIVOS MP3:
        Los archivos de audio no están incluidos por su gran tamaño.
        Deben nombrarse: 1.mp3, 2.mp3, ... 614.mp3
        README
        
        # Create ZIP
        cd dist
        zip -r ../HimnarioAdventista-Linux.zip HimnarioAdventista

    - name: Upload Linux package
      uses: actions/upload-artifact@v4
      with:
        name: HimnarioAdventista-Linux
        path: HimnarioAdventista-Linux.zip
        retention-days: 30
