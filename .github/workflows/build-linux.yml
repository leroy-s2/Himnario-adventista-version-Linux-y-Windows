name: Build Linux AppImage

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Linux build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y ninja-build libgtk-3-dev

    - name: Get Flutter packages
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze --no-fatal-infos --no-fatal-warnings || true

    - name: Build Linux app
      run: flutter build linux --release

    - name: Create AppImage
      run: |
        # Download appimagetool
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons
        
        # Copy built app
        cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/himnario-adventista.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Himnario Adventista
        Comment=Himnario de la Iglesia Adventista
        Exec=himnario_adventista
        Icon=himnario-adventista
        Categories=Audio;Music;
        Terminal=false
        EOF
        
        # Create simple icon
        if [ -f "assets/images/icon.png" ]; then
          cp assets/images/icon.png AppDir/himnario-adventista.png
        else
          # Create placeholder icon
          sudo apt-get install -y imagemagick
          convert -size 256x256 xc:'#8B6914' -fill white -gravity center -pointsize 64 -annotate 0 'HA' AppDir/himnario-adventista.png
        fi
        
        # Create AppRun
        cat > AppDir/AppRun << 'APPRUN'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "$0")")"
        export LD_LIBRARY_PATH="$HERE/usr/bin/lib:$LD_LIBRARY_PATH"
        exec "$HERE/usr/bin/himnario_adventista" "$@"
        APPRUN
        chmod +x AppDir/AppRun
        
        # Build AppImage
        ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir HimnarioAdventista-Linux-x86_64.AppImage

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: HimnarioAdventista-Linux
        path: HimnarioAdventista-Linux-x86_64.AppImage
        retention-days: 30
