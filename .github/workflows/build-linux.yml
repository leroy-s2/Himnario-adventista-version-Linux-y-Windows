name: Build Linux AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
        sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
        sudo apt-get install -y gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly
        sudo apt-get install -y fuse libfuse2

    - name: Create audio directories
      run: |
        mkdir -p assets/audio/cantado
        mkdir -p assets/audio/instrumental
        echo "Audio files should be downloaded separately" > assets/audio/README.txt

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Build Linux Release
      run: flutter build linux --release

    - name: Prepare AppImage structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy Flutter build
        cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/himnario-adventista.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Himnario Adventista
        Comment=Himnario de la Iglesia Adventista del Septimo Dia
        Exec=himnario_adventista
        Icon=himnario-adventista
        Categories=Audio;Music;Education;
        Terminal=false
        EOF
        
        # Copy icon
        if [ -f "assets/images/icon.png" ]; then
          cp assets/images/icon.png AppDir/himnario-adventista.png
        else
          # Create a simple placeholder icon
          echo "No icon found, using placeholder"
          convert -size 256x256 xc:#8B6914 -fill white -gravity center -pointsize 72 -annotate 0 "HA" AppDir/himnario-adventista.png 2>/dev/null || \
          wget -O AppDir/himnario-adventista.png "https://via.placeholder.com/256/8B6914/FFFFFF?text=HA" 2>/dev/null || \
          touch AppDir/himnario-adventista.png
        fi
        
        # Create AppRun script
        cat > AppDir/AppRun << 'APPRUN'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "$0")")"
        export LD_LIBRARY_PATH="$HERE/usr/bin/lib:$LD_LIBRARY_PATH"
        exec "$HERE/usr/bin/himnario_adventista" "$@"
        APPRUN
        chmod +x AppDir/AppRun

    - name: Download appimagetool
      run: |
        wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
        chmod +x appimagetool

    - name: Build AppImage
      run: |
        ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir HimnarioAdventista-x86_64.AppImage

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: HimnarioAdventista-Linux-AppImage
        path: HimnarioAdventista-x86_64.AppImage
        retention-days: 30
